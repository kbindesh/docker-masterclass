# Managing Containers with `Docker Compose`

## Docker Compose - Overview

- **Docker Compose** is a docker tool managing multi-container Docker applications.
- It is defined using the compose file format.
- With a compose file, you can create and start all of the services defined in your configuration with a single command.

## Understanding `declarative` vs `imperative` orchestration of containers

- Docker Compose is a Docker tool that is primarily used when you need to run and orchestrate containers running on a single Docker host.
- Docker Compose is embedded in the normal Docker CLI.
- Docker Compose uses files formatted in **YAML** format.
- By default, Docker Compose expects these files to be called **docker-compose.yml**, however other names are possible.
- The content of a **docker-compose.yml** file is a declarative way of describing and running a containerized **application essentially consisting of more than single container**.

- **What do you mean by `Imperative` here**?

  - This is a way in which we can solve problems by specifying the exact procedure
    that has to be followed by the system.

- **What do you mean by `Declarative` here**?

  - This is a way in which we can solve problems without requiring the developer
    to specify an exact procedure to be followed in order to accomplish a task.
  - You simply tell docker engine about your desired state for an application, and docker will figure out how to achieve it.
  - However this approach is inefficient and practically not possible to mid or large application with 100s of containers.
  - With the _Docker Compose_ tool, we are given a way to define the application in a declarative way in a file that uses the YAML format.

## How Docker Compose works?

- Docker Compose relies on a YAML configuration file, usually named **compose.yaml** or **docker-compose.yml**.
- The **compose.yaml** file follows the rules provided by the Compose Specification in how to define multi-container applications.

### The Compose application model

- **Services**
  - Computing components of an application are defined as _services_.
  - A service is an abstract concept implemented on platforms by running the same container image, and configuration, one or more times.
- **Networks**
  - Services communicate with each other through networks.
  - A network is a platform capability abstraction to establish an IP route between containers within services connected together.
- **Volumes**
  - Services store and share persistent data into volumes
- **Configs**
  - You may have services that require configuration data that is dependent on the runtime or platform.
- **Secrets**
  - Secrets can be for storing sensitive data that should not be exposed without security considerations.
  - Secrets are made available to services as files mounted into their containers.

## Multi-service application with Docker Compose

- If you want to run a multi-service application, you can of course start all the
  participating containers with the well-known _docker container run_ command.

### Step-01: Create and analyze a docker-compose.yml file

- Download and Install VS Code IDE (https://code.visualstudio.com/download)
- Install Required VS Code Plugins: [Docker](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker)
- Create a new file with a label docker-compose.yml and add below config to it:

```
version: "3.8"
services:
  db:
    image: postgres:alpine
    environment:
    - POSTGRES_USER=dockeruser
    - POSTGRES_PASSWORD=dockerpass
    - POSTGRES_DB=pets
    volumes:
    - pg-data:/var/lib/postgresql/data
    - ./db:/docker-entrypoint-initdb.d

  pgadmin:
    image: dpage/pgadmin4
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@acme.com
      PGADMIN_DEFAULT_PASSWORD: admin
    volumes:
      - pgadmin-data:/var/lib/pgadmin

volumes:
  pg-data:
  pgadmin-data:

```

## 04. Managing Containers with `Docker Compose`

### 4.1 Create and analyze a `docker-compose.yml` file

- You may refer to [multi-service-app-01](./multi-service-app-01/) application for sample docker-compose.yml file.

- Launch any IDE (VS Code) >> Create and open a new folder for the App >> Add the above created docker-compose.yml file to it.

- The compose file has the following resources to deploy:

  1. postgresql (database) service
  2. pgadmin (sql client) service
  3. data volume for postgres service
  4. data volume for pgadmin service

- Now, create a folder called **db** in the App folder and add a file called [init-db.sql](./multi-service-app-01/init-db.sql) to it. This sql script will create a new table in the images database and insert few sample records to it.

### 4.2 `Deploy the application` with Docker Compose

```
# Deploy an application in foreground
docker compose up

# (optional) Deploy an application in the background
docker-compose up --detach
OR
docker-compose up -d

# (optional) Deploying an app with compose file having a different name (other than docker-compose.yml)
docker-compose  -f <docker_compose_file_name.yml> up
```

- **List all services that are part of the application**

```
docker-compose ps
```

### 4.3 Access the deployed application over the web

- As mentioned in the _docker-compose.yml_ file, **pgadmin (sql client) service** listens on **port 5050**, kindly allow ingress traffic on port 5050 on docker host security group.

- Open a browser on your host machine and go to localhost/dockerhost machine by using the specified port from the docker-compose.yaml file, such as http://localhost:5050. Pgadmin logic pages should be available.

```
http://<public_ip_of_docker_host>:5050

# In case you have configured docker host on your local system
http://localhost:5050

[You should see pgadmin login page]
```

- Login to pgadmin web UI using the credentials provided in the docker-compose.yml file.

### 4.4 `Stop and Delete application resources` using Docker compose

```
# To stop and clean up the application resources
docker compose down

# Clean-up all the app resources along with volume
docker compose down -v

[Above command will delete containers, volumes and all the other app associated resources]
```

### 4.5 `Building images` with Docker Compose

- The previous multi-service application had two pre-built images to deploy and didn't have any docker image to build.

- In this section, we will learn how you can:

  1. **Package multiple services into respective docker images**
  2. **Deploy multi-service app using docker compose**

- **Download/clone sample `Voting application` source code**

  - This simple **distributed voting application** runs across multiple Docker containers.
  - You may download or clone the code from this GitHub repo link: https://github.com/dockersamples/example-voting-app/tree/main
  - Once download, extract and open the folder in an IDE (VS Code)

### 4.6 `Scaling a service` with Docker Compose (manual)

```
# Syntax
docker compose up --scale <service_name>=<replicas>

# Example
docker compose up --scale web=3
```

### 4.7 `Building and pushing an application` using Docker Compose

```
# Build the application
docker compose -f docker-compose.yml build

# To push all images to Docker Hub, we can use docker compose push
docker login -u <registry_username> -p <registry_password>

# Assuming the login succeeds, you can then push the image
docker compose -f docker-compose.yml push

```

## 05. View example Projects that use Docker

- https://github.com/docker/awesome-compose
